'''
Business: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö –≤ Telegram
Args: event - dict —Å httpMethod, body (–¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞)
      context - –æ–±—ä–µ–∫—Ç —Å –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ request_id, function_name
Returns: HTTP response dict —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏
'''

import json
import os
from typing import Dict, Any
import urllib.request
import urllib.parse

def handler(event: Dict[str, Any], context: Any) -> Dict[str, Any]:
    method: str = event.get('httpMethod', 'POST')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Max-Age': '86400'
            },
            'body': '',
            'isBase64Encoded': False
        }
    
    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': 'Method not allowed'}),
            'isBase64Encoded': False
        }
    
    bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
    chat_id = os.environ.get('TELEGRAM_CHAT_ID')
    
    if not bot_token or not chat_id:
        print('[ERROR] Telegram credentials not configured')
        return {
            'statusCode': 500,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': 'Telegram not configured'}),
            'isBase64Encoded': False
        }
    
    body_data = json.loads(event.get('body', '{}'))
    order = body_data.get('order', {})
    
    delivery_type_map = {
        'delivery': '–î–æ—Å—Ç–∞–≤–∫–∞',
        'pickup': '–°–∞–º–æ–≤—ã–≤–æ–∑'
    }
    
    payment_type_map = {
        'card': '–ö–∞—Ä—Ç–æ–π –æ–Ω–ª–∞–π–Ω',
        'cash': '–ù–∞–ª–∏—á–Ω—ã–º–∏',
        'card_courier': '–ö–∞—Ä—Ç–æ–π –∫—É—Ä—å–µ—Ä—É'
    }
    
    delivery_type = delivery_type_map.get(order.get('deliveryType', ''), order.get('deliveryType', '–ù–µ —É–∫–∞–∑–∞–Ω–æ'))
    payment_type = payment_type_map.get(order.get('paymentType', ''), order.get('paymentType', '–ù–µ —É–∫–∞–∑–∞–Ω–æ'))
    
    items_text = '\n'.join([
        f"‚Ä¢ {item.get('title', '–¢–æ–≤–∞—Ä')} ‚Äî {item.get('quantity', 1)} —à—Ç √ó {item.get('price', 0)} ‚ÇΩ"
        for item in order.get('items', [])
    ])
    
    message = f"""üõí <b>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #{order.get('orderNumber', 'N/A')}</b>

üë§ <b>–ö–ª–∏–µ–Ω—Ç:</b> {order.get('name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
üìß <b>Email:</b> {order.get('email', '–ù–µ —É–∫–∞–∑–∞–Ω')}
üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {order.get('phone', '–ù–µ —É–∫–∞–∑–∞–Ω')}

üì¶ <b>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏:</b> {delivery_type}
üí≥ <b>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</b> {payment_type}
üìç <b>–ê–¥—Ä–µ—Å:</b> {order.get('address', '–ù–µ —É–∫–∞–∑–∞–Ω')}
üèô <b>–ì–æ—Ä–æ–¥:</b> {order.get('city', '–ù–µ —É–∫–∞–∑–∞–Ω')}

<b>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</b>
{items_text}

üí∞ <b>–ò—Ç–æ–≥–æ:</b> {order.get('totalAmount', 0)} ‚ÇΩ
"""
    
    if order.get('comment'):
        message += f"\nüí¨ <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> {order.get('comment')}"
    
    telegram_url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
    data = {
        'chat_id': chat_id,
        'text': message,
        'parse_mode': 'HTML'
    }
    
    try:
        req = urllib.request.Request(
            telegram_url,
            data=json.dumps(data).encode('utf-8'),
            headers={'Content-Type': 'application/json'}
        )
        with urllib.request.urlopen(req) as response:
            result = json.loads(response.read().decode('utf-8'))
            print(f'[SUCCESS] Telegram notification sent for order {order.get("orderNumber")}')
            
            return {
                'statusCode': 200,
                'headers': {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                'body': json.dumps({'success': True, 'result': result}),
                'isBase64Encoded': False
            }
    except Exception as e:
        print(f'[ERROR] Failed to send Telegram notification: {str(e)}')
        return {
            'statusCode': 500,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': str(e)}),
            'isBase64Encoded': False
        }
